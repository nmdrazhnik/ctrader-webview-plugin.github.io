<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>cTrader WebView Plugin — Single File</title>
  <style>
    :root{
      --bg:#0d1117;--fg:#e6edf3;--muted:#8b949e;
      --card:#161b22;--card2:#0f141a;--accent:#58a6ff;--ok:#3fb950;--warn:#d29922;--err:#f85149;
      --border:#30363d;
    }
    .light{ --bg:#ffffff; --fg:#24292f; --muted:#57606a; --card:#f6f8fa; --card2:#ffffff; --border:#d0d7de; --accent:#0969da; --ok:#1a7f37; --warn:#9a6700; --err:#cf222e;}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:flex;justify-content:center;align-items:center;padding:20px}
    .app{width:min(920px,100%);}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--card2)}
    header h1{font-size:16px;margin:0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}
    .box{border:1px dashed var(--border);padding:12px;border-radius:12px;background:rgba(255,255,255,.02)}
    .muted{color:var(--muted);font-size:12px}
    button,select{appearance:none;background:var(--card2);border:1px solid var(--border);color:var(--fg);padding:10px 12px;border-radius:10px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:transparent}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;font:12px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    #boot{padding:10px 12px;background:transparent;border-top:1px solid var(--border);max-height:180px;overflow:auto}
    .kbd{font:11px ui-monospace,monospace;background:var(--card2);border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <h1>cTrader WebView Plugin — Single File</h1>
        <div class="row">
          <span id="status" class="pill muted">Connecting…</span>
          <button id="themeBtn" class="pill">Toggle Theme</button>
        </div>
      </header>
      <div style="padding:14px 16px">
        <div class="grid">
          <div class="box">
            <div class="row" style="align-items:center;justify-content:space-between">
              <div>
                <div class="muted">Environment</div>
                <div style="margin-top:6px">
                  <div><span class="muted">Protocol:</span> <span id="proto"></span></div>
                  <div><span class="muted">Lang:</span> <span id="lang"></span></div>
                  <div><span class="muted">Platform:</span> <span id="platform"></span></div>
                  <div><span class="muted">Placement:</span> <span id="placement"></span></div>
                </div>
              </div>
              <div class="row">
                <button id="btnAccount" disabled>Account info</button>
                <button id="btnReconnect" class="warn">Reconnect</button>
              </div>
            </div>
          </div>
          <div class="box">
            <div class="row" style="gap:8px;align-items:center">
              <select id="symbol" disabled></select>
              <button id="btnLoad" disabled>Load symbols</button>
              <button id="btnSub" disabled>Subscribe</button>
              <button id="btnUnsub" disabled>Unsubscribe</button>
            </div>
            <div style="margin-top:10px">
              <div class="muted">Quote</div>
              <pre id="quote">—</pre>
            </div>
          </div>
        </div>

        <div class="box" style="margin-top:12px">
          <div class="muted">Log</div>
          <pre id="log"></pre>
        </div>
      </div>
      <div id="boot"><pre id="bootlog"></pre></div>
    </div>
    <p class="muted" style="margin-top:8px">URL accepts <span class="kbd">?theme=dark|light</span>, <span class="kbd">lang=ru|en</span>, <span class="kbd">platform=ios|android|web</span>, <span class="kbd">placement=...</span>, <span class="kbd">symbol=...</span></p>
  </div>

  <!-- Bootloader + dynamic ESM import so we can show concrete errors in WebView -->
  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      const themeParam = (qs.get('theme')||'dark').toLowerCase();
      const langParam = (qs.get('lang')||'en').toLowerCase();
      const symbolParam = qs.get('symbol') || '';
      const platform = qs.get('platform')||'ios';
      const placement = qs.get('placement')||'';
      const $ = (id)=>document.getElementById(id);
      const L = (m)=>{ $('bootlog').textContent += (typeof m==='string'?m:JSON.stringify(m)) + '\\n'; };
      const Log = (m)=>{ $('log').textContent += '['+new Date().toLocaleTimeString()+'] ' + (typeof m==='string'?m:JSON.stringify(m)) + '\\n'; };
      $('proto').textContent = location.protocol;
      $('lang').textContent = langParam;
      $('platform').textContent = platform;
      $('placement').textContent = placement;
      if(themeParam === 'light'){ document.body.classList.add('light'); }
      $('themeBtn').onclick = ()=> document.body.classList.toggle('light');
      $('status').textContent = 'Booting…';

      // Basic i18n strings
      const i18n = {
        en:{ connected:'Connected', disconnected:'Disconnected', importing:'Importing SDK…', importFail:'Import failed — bundle locally', handshake:'Handshaking…', subscribed:'Subscribed', unsubscribed:'Unsubscribed' },
        ru:{ connected:'Подключено', disconnected:'Отключено', importing:'Загружаем SDK…', importFail:'Импорт не удался — соберите локальный бандл', handshake:'Рукопожатие…', subscribed:'Подписка активна', unsubscribed:'Подписка снята' }
      };
      const T = (k)=> (i18n[langParam]||i18n.en)[k] || k;

      window.addEventListener('error', e=>L('ERROR: '+e.message));
      window.addEventListener('unhandledrejection', e=>L('REJECTION: '+(e.reason?.message||e.reason)));

      (async function main(){
        L(T('importing'));
        try{
          const [{ createClientAdapter }, sdk] = await Promise.all([
            import('https://esm.sh/@spotware-web-team/sdk-external-api@0.0.9'),
            import('https://esm.sh/@spotware-web-team/sdk@0.0.9')
          ]);

          L(T('handshake'));
          const adapter = createClientAdapter({});
          let connected = false;

          // Confirm responder (one-shot is fine)
          const confirmSub = sdk.handleConfirmEvent(adapter, {}).subscribe(()=>{});

          const setStatus = (ok)=>{
            $('status').textContent = ok ? T('connected') : T('disconnected');
            $('status').className = 'pill ' + (ok?'ok':'');
          };

          const onConnected = ()=>{
            connected = true;
            setStatus(true);
            Log('Connected to host');
            $('btnAccount').disabled = false;
            $('btnLoad').disabled = false;
          };

          sdk.registerEvent(adapter, {}).subscribe({ next: onConnected, error: err=>Log('registerEvent error: '+(err?.message||err)) });

          // UI handlers
          $('btnReconnect').onclick = ()=>{
            Log('Manual reconnect');
            setStatus(false);
            sdk.registerEvent(adapter, {}).subscribe({ next: onConnected, error: err=>Log('registerEvent error: '+(err?.message||err)) });
          };

          $('btnAccount').onclick = ()=>{
            try{
              sdk.getAccountInformation(adapter, {}).subscribe((res)=>{
                Log('AccountInformation: '+JSON.stringify(res));
              });
            }catch(e){ Log('getAccountInformation error: '+(e.message||e)); }
          };

          const $symbol = $('symbol');
          $('btnLoad').onclick = ()=>{
            $symbol.innerHTML = '';
            sdk.getLightSymbolList(adapter, {}).subscribe((list)=>{
              // list.items ? depends on SDK; try both
              const items = list?.items || list || [];
              items.slice(0,500).forEach(s=>{
                const name = s?.symbolName || s?.name || s;
                if(!name) return;
                const opt = document.createElement('option');
                opt.value = name; opt.textContent = name;
                $symbol.appendChild(opt);
              });
              $symbol.disabled = false;
              $('btnSub').disabled = false;
              $('btnUnsub').disabled = false;
              if(symbolParam){ $symbol.value = symbolParam; }
              Log('Symbols loaded: '+$symbol.options.length);
            });
          };

          let quoteSub = null;
          $('btnSub').onclick = ()=>{
            const sym = $symbol.value;
            if(!sym) return;
            if(quoteSub){ quoteSub.unsubscribe?.(); quoteSub = null; }
            // Subscribe + listen to quotes
            sdk.subscribeQuotes(adapter, { symbolName: sym }).subscribe(()=>{
              Log(T('subscribed')+': '+sym);
            });
            quoteSub = sdk.quoteEvent(adapter, { symbolName: sym }).subscribe((q)=>{
              $('quote').textContent = JSON.stringify(q, null, 2);
            });
          };

          $('btnUnsub').onclick = ()=>{
            const sym = $symbol.value;
            if(!sym) return;
            try{
              sdk.unsubscribeQuotes(adapter, { symbolName: sym }).subscribe(()=>{
                Log(T('unsubscribed')+': '+sym);
              });
              if(quoteSub){ quoteSub.unsubscribe?.(); quoteSub = null; }
            }catch(e){ Log('unsubscribe error: '+(e.message||e)); }
          };

          // Prefetch if symbol set via URL
          if(symbolParam){ $('btnLoad').click(); }

        }catch(err){
          L(T('importFail')+': '+(err?.message||err));
          $('status').textContent = 'SDK import failed'; $('status').className = 'pill err';
          // show hint in page log too
          document.getElementById('log').textContent =
            'SDK import failed. If WebView blocks external ESM, build a local bundle (see README).';
        }
      })();
    })();
  </script>
</body>
</html>
